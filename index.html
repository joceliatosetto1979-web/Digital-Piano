<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>Virtual Piano+</title>
    <style>
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; margin: 0; padding: 0; }
        body, html { width: 100vw; height: 100vh; overflow: hidden; background: #000; font-family: sans-serif; display: flex; flex-direction: column; }
        .tela { position: absolute; width: 100%; height: 100%; display: none; flex-direction: column; align-items: center; justify-content: center; background: #111; z-index: 10; }
        .ativa { display: flex; }
        #painel { height: 25%; width: 100%; background: #1a1a1a; display: flex; flex-direction: column; justify-content: space-around; padding: 10px; border-bottom: 2px solid #333; }
        .linha { display: flex; justify-content: space-between; align-items: center; width: 100%; gap: 10px; }
        input[type=range] { flex: 1; accent-color: #FFD700; }
        #teclado { height: 75%; width: 100%; display: flex; overflow-x: auto; touch-action: none; background: #000; }
        .tecla { flex-shrink: 0; position: relative; border-radius: 0 0 10px 10px; display: flex; justify-content: center; align-items: flex-end; padding-bottom: 20px; user-select: none; border: 1px solid #999; }
        .branca { width: 70px; height: 100%; background: white; color: #333; }
        .preta { width: 45px; height: 60%; background: #222; color: white; margin-left: -22.5px; margin-right: -22.5px; z-index: 2; border: 1px solid #000; }
        .alvo-amarelo { background: #FFD700 !important; box-shadow: 0 0 20px #FFD700; z-index: 3; }
        .progress-bar { position: absolute; bottom: 0; left: 0; width: 100%; height: 0%; background: rgba(255, 255, 255, 0.6); pointer-events: none; }
        .btn { padding: 8px 12px; border-radius: 5px; border: none; font-weight: bold; cursor: pointer; color: white; }
        .btn-menu { width: 220px; padding: 18px; margin: 10px; border-radius: 50px; font-size: 1.1rem; background: #4CAF50; }
        .item-musica { background:#000; color: white; border: 1px solid #333; margin-bottom:10px; padding:15px; border-radius:12px; display:flex; justify-content:space-between; align-items:center; width: 90%; }
        .creditos { position: absolute; bottom: 10px; right: 10px; color: rgba(255,255,255,0.5); font-size: 12px; z-index: 20; pointer-events: none; }
    </style>
</head>
<body>
    <div id="m-p" class="tela ativa">
        <h1 style="color:#FFD700; margin-bottom:30px;">Virtual Piano+</h1>
        <button class="btn-menu" onclick="irJogo()">PLAY</button>
        <button class="btn-menu" style="background:#2196F3;" onclick="irMus()">MUSICS</button>
        <div class="creditos">Feito por: João Gabriel Morais</div>
    </div>
    <div id="t-m" class="tela" style="justify-content:flex-start; padding:20px; overflow-y:auto;">
        <button class="btn" style="background:#555; margin-bottom:20px;" onclick="irMenu()">⬅ VOLTAR</button>
        <div id="lista-m" style="width:100%; display: flex; flex-direction: column; align-items: center;"></div>
    </div>
    <div id="t-j" class="tela" style="justify-content:flex-start;">
        <div id="painel">
            <div class="linha">
                <button class="btn" style="background:#f44336;" onclick="irMenu()">SAIR</button>
                <div style="text-align:center;"><b id="txt-m">Livre</b><br><small id="cont-n" style="color:#FFD700; font-weight:bold;"></small></div>
                <button id="btn-rec" class="btn" style="background:#555;" onclick="toggleRec()">⏺ GRAVAR</button>
            </div>
            <div class="linha">
                <small>TOM (PITCH):</small>
                <input type="range" id="pitch" min="0.5" max="2.5" step="0.1" value="1.0">
            </div>
            <div class="linha">
                <small>VOL:</small>
                <input type="range" id="vol" min="0" max="1" step="0.1" value="0.5" oninput="mG.gain.value = this.value">
                <span id="timer" style="color:#FFD700; font-family:monospace;">00:00</span>
            </div>
        </div>
        <div id="teclado"></div>
        <div class="creditos">Feito por: João Gabriel Morais</div>
    </div>
<script>
    let ctx, mG, rec, chunks = [], notas = new Map();
    let mus = null, passo = 0, seg = 0, tTimer, segurando = false, prog = 0, loopProg;
    let teclaAtual = null;

    const banco = [
        { id: 1, nome: "Happy Birthday", seq: [[0, 300], [0, 300], [2, 800], [0, 800], [5, 800], [4, 1200], [0, 300], [0, 300], [2, 800], [0, 800], [7, 800], [5, 1200], [0, 300], [0, 300], [12, 800], [9, 800], [5, 800], [4, 800], [2, 1000], [10, 300], [10, 300], [9, 800], [5, 800], [7, 800], [5, 1500]] },
        { id: 2, nome: "Baby Shark", seq: [[7, 400], [9, 400], [12, 200], [12, 200], [12, 200], [12, 100], [12, 100], [12, 100], [7, 400], [9, 400], [12, 200], [12, 200], [12, 200], [12, 100], [12, 100], [12, 100], [7, 400], [9, 400], [12, 200], [12, 200], [12, 200], [12, 100], [12, 100], [12, 100], [12, 400], [12, 400], [11, 1000]] },
        { id: 3, nome: "Bate o Sino", seq: [[4, 400], [4, 400], [4, 800], [4, 400], [4, 400], [4, 800], [4, 400], [7, 400], [0, 400], [2, 400], [4, 1200], [5, 400], [5, 400], [5, 400], [5, 400], [5, 400], [4, 400], [4, 400], [4, 200], [4, 200], [4, 400], [2, 400], [2, 400], [4, 400], [2, 800], [7, 800], [4, 400], [4, 400], [4, 800], [4, 400], [4, 400], [4, 800], [4, 400], [7, 400], [0, 400], [2, 400], [4, 1200], [5, 400], [5, 400], [5, 400], [5, 400], [5, 400], [4, 400], [4, 400], [7, 400], [7, 400], [5, 400], [2, 400], [0, 1500]] },
        { id: 4, nome: "Despacito", seq: [[14, 600], [9, 600], [5, 300], [7, 300], [9, 300], [10, 300], [12, 300], [14, 300], [10, 600], [10, 300], [10, 300], [10, 300], [10, 300], [14, 300], [14, 300], [14, 300], [14, 300], [15, 300], [14, 300], [12, 300], [10, 600], [7, 600], [14, 600], [9, 600], [5, 300], [7, 300], [9, 300], [10, 300], [12, 300], [14, 300], [10, 800]] },
        { id: 5, nome: "Piratas do Caribe", seq: [[9, 200], [12, 200], [14, 200], [14, 400], [14, 200], [15, 200], [17, 200], [17, 400], [17, 200], [19, 200], [15, 200], [15, 400], [14, 200], [12, 200], [12, 200], [14, 600], [9, 200], [12, 200], [14, 200], [14, 400], [14, 200], [15, 200], [17, 200], [17, 400], [17, 200], [19, 200], [15, 200], [15, 400], [14, 200], [12, 200], [14, 800]] }
    ];

    function init() {
        if(!ctx) {
            ctx = new (window.AudioContext || window.webkitAudioContext)();
            mG = ctx.createGain(); mG.gain.value = 0.5; mG.connect(ctx.destination);
            let dest = ctx.createMediaStreamDestination(); mG.connect(dest);
            rec = new MediaRecorder(dest.stream);
            rec.ondataavailable = e => chunks.push(e.data);
            rec.onstop = () => {
                let blob = new Blob(chunks, {type:'audio/webm'});
                let url = URL.createObjectURL(blob);
                let a = document.createElement('a'); a.href = url; a.download = 'piano-record.webm'; a.click();
            };
        }
    }

    function toggleRec() { init(); const btn = document.getElementById('btn-rec'); if(rec.state === 'inactive') { chunks = []; rec.start(); btn.innerText = "⏹ PARAR"; btn.style.background = "#f44336"; } else { rec.stop(); btn.innerText = "⏺ GRAVAR"; btn.style.background = "#555"; } }
    function irMenu() { clearInterval(loopProg); clearInterval(tTimer); document.querySelectorAll('.tela').forEach(t=>t.classList.remove('ativa')); document.getElementById('m-p').classList.add('ativa'); }
    function irJogo() { document.querySelectorAll('.tela').forEach(t=>t.classList.remove('ativa')); document.getElementById('t-j').classList.add('ativa'); init(); mus = null; document.getElementById('txt-m').innerText = "Livre"; document.getElementById('cont-n').innerText = ""; clearInterval(tTimer); document.getElementById('timer').innerText = "00:00"; document.querySelectorAll('.tecla').forEach(t => t.classList.remove('alvo-amarelo')); }
    function irMus() { document.querySelectorAll('.tela').forEach(t=>t.classList.remove('ativa')); document.getElementById('t-m').classList.add('ativa'); const lista = document.getElementById('lista-m'); lista.innerHTML = ''; banco.forEach(m => { lista.innerHTML += `<div class="item-musica"><span>${m.nome}</span> <button class="btn" style="background:#FFD700; color:#000;" onclick="playM(${m.id})">TOCAR</button></div>`; }); }

    function playM(id) {
        mus = banco.find(m => m.id === id); passo = 0; seg = 0;
        document.querySelectorAll('.tela').forEach(t=>t.classList.remove('ativa'));
        document.getElementById('t-j').classList.add('ativa');
        init(); document.getElementById('txt-m').innerText = mus.nome;
        clearInterval(tTimer);
        tTimer = setInterval(() => { seg++; let m=Math.floor(seg/60).toString().padStart(2,'0'), s=(seg%60).toString().padStart(2,'0'); document.getElementById('timer').innerText=m+':'+s; }, 1000);
        prox();
    }

    function prox() {
        document.querySelectorAll('.tecla').forEach(t => { 
            t.classList.remove('alvo-amarelo'); 
            if(t.querySelector('.progress-bar')) t.querySelector('.progress-bar').style.height = '0%'; 
        });
        if(mus && passo >= mus.seq.length) {
            let nF = mus.nome; mus = null; document.getElementById('txt-m').innerText = "Livre"; document.getElementById('cont-n').innerText = "";
            clearInterval(tTimer); setTimeout(() => alert("Música Completa: " + nF + "!"), 150); return;
        }
        if(mus) {
            document.getElementById('k'+mus.seq[passo][0]).classList.add('alvo-amarelo');
            document.getElementById('cont-n').innerText = `Nota: ${passo + 1} / ${mus.seq.length}`;
        }
    }

    function handleStart(id, freq) {
        init(); let f = freq * document.getElementById('pitch').value; som(f, id);
        if(mus && id === 'k'+mus.seq[passo][0]) {
            segurando = true; prog = 0; if(loopProg) clearInterval(loopProg);
            loopProg = setInterval(() => {
                prog += 50; let p = (prog / mus.seq[passo][1]) * 100;
                let el = document.getElementById(id); if(el && el.querySelector('.progress-bar')) el.querySelector('.progress-bar').style.height = Math.min(p, 100) + '%';
                if(prog >= mus.seq[passo][1]) { clearInterval(loopProg); }
            }, 50);
        }
    }

    function handleEnd(id) {
        off(id); if(mus && segurando && id === 'k'+mus.seq[passo][0]) { passo++; prox(); }
        segurando = false; if(loopProg) clearInterval(loopProg);
        let el = document.getElementById(id); if(el && el.querySelector('.progress-bar')) el.querySelector('.progress-bar').style.height = '0%';
    }

    const tcl = document.getElementById('teclado'), nms = ['Dó','Dó#','Ré','Ré#','Mi','Fá','Fá#','Sol','Sol#','Lá','Lá#','Si','Dó2'];
    for(let i=0; i<25; i++) {
        let div = document.createElement('div'), f = 130.81 * Math.pow(2, i/12), id = 'k'+i;
        div.className = 'tecla ' + (nms[i%12].includes('#') ? 'preta' : 'branca');
        div.id = id; div.innerHTML = `<div class="progress-bar"></div><small style="pointer-events:none; font-size:9px;">${nms[i%12]}</small>`;
        div.onpointerdown = (e) => { div.setPointerCapture(e.pointerId); teclaAtual = id; handleStart(id, f); };
        div.onpointerenter = (e) => { if(e.buttons === 1) { teclaAtual = id; handleStart(id, f); } };
        div.onpointerleave = (e) => { if(teclaAtual === id) handleEnd(id); };
        div.onpointerup = (e) => { handleEnd(id); teclaAtual = null; };
        tcl.appendChild(div);
    }

    function som(f, id) { 
        if(!ctx || notas.has(id)) return; document.getElementById(id).style.filter = "brightness(0.7)"; 
        let o=ctx.createOscillator(), g=ctx.createGain(); o.type='triangle'; o.frequency.value=f; 
        g.gain.setValueAtTime(0, ctx.currentTime); g.gain.linearRampToValueAtTime(0.4, ctx.currentTime+0.02); 
        o.connect(g); g.connect(mG); o.start(); notas.set(id, {o, g}); 
    }

    function off(id) { 
        let n=notas.get(id); if(n) { let el = document.getElementById(id); if(el) el.style.filter = "none"; 
        n.g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + 0.1); n.o.stop(ctx.currentTime + 0.15); notas.delete(id); } 
    }
</script>
</body>
                    </html>
                
