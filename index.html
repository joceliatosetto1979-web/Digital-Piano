<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <title>Piano Sensorial Pro - Elite</title>
    <style>
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; margin: 0; padding: 0; }
        body, html { width: 100vw; height: 100vh; overflow: hidden; background: #000; font-family: sans-serif; display: flex; flex-direction: column; }
        .tela { position: absolute; width: 100%; height: 100%; display: none; flex-direction: column; align-items: center; justify-content: center; background: #111; z-index: 10; padding: 20px; }
        .ativa { display: flex; }
        /* Painel Superior Ocupando 35% e Folha de Rascunho Interna */
        #painel { height: 35%; width: 100%; background: #1a1a1a; display: flex; flex-direction: column; justify-content: space-around; padding: 10px; border-bottom: 2px solid #333; position: relative; }
        #container-progresso { width: 100%; height: 6px; background: #333; border-radius: 3px; overflow: hidden; display: none; }
        #barra-progresso { width: 0%; height: 100%; background: #4CAF50; transition: width .3s; }
        .linha { display: flex; justify-content: space-between; align-items: center; width: 100%; gap: 10px; color: white; font-size: 0.8rem; }
        input[type=range] { flex: 1; accent-color: #FFD700; }
        /* Teclado Ocupando 65% */
        #teclado { height: 65%; width: 100%; display: flex; overflow-x: auto; touch-action: none; background: #000; padding-top: 10px; }
        .tecla { flex-shrink: 0; position: relative; border-radius: 0 0 10px 10px; display: flex; justify-content: center; align-items: flex-end; padding-bottom: 20px; user-select: none; border: 1px solid #999; transition: transform .05s, background .05s; cursor: pointer; overflow: hidden; }
        .branca { width: 70px; height: 100%; background: #fff; color: #333; z-index: 1; }
        .preta { width: 45px; height: 60%; background: #222; color: #fff; margin-left: -22.5px; margin-right: -22.5px; z-index: 2; border: 1px solid #000; }
        /* Anima√ß√µes de Toque */
        .tecla-ativa-branca { background: #bbb !important; transform: translateY(5px); box-shadow: inset 0 5px 10px #888; }
        .tecla-ativa-preta { background: #000 !important; transform: translateY(5px); }
        .progresso-nota { position: absolute; bottom: 0; left: 0; width: 100%; background: #FFD700; height: 0%; z-index: 0; opacity: .8; pointer-events: none; }
        .alvo-amarelo { border: 4px solid #FFD700 !important; box-shadow: 0 0 20px #FFD700; }
        .btn { padding: 8px 12px; border-radius: 8px; border: none; font-weight: 700; cursor: pointer; color: #fff; font-size: 0.7rem; }
        #folha { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #fff; z-index: 20; display: none; flex-direction: column; }
        #txt-folha { flex: 1; width: 100%; padding: 10px; border: none; resize: none; font-size: 1rem; outline: none; color: #000; }
    </style>
</head>
<body>
<div id="m-p" class="tela ativa">
    <h1 style="color:#FFD700; margin-bottom:10px;">PIANO SENSORIAL</h1>
    <button class="btn" style="background:#4CAF50; width:260px; padding:18px; margin:10px; border-radius:50px; font-weight:bold" onclick="ligarTudo(); irJogo();">MODO LIVRE</button>
    <button class="btn" style="background:#2196F3; width:260px; padding:18px; margin:10px; border-radius:50px; font-weight:bold" onclick="irMus()">M√öSICAS COMPLETAS</button>
    <button class="btn" style="background:#FF9800; width:260px; padding:18px; margin:10px; border-radius:50px; font-weight:bold" onclick="irSalvas()">GRAVA√á√ïES</button>
</div>
<div id="t-m" class="tela" style="justify-content:flex-start; overflow-y:auto">
    <button class="btn" style="background:#444; margin-bottom:20px; width: 100%" onclick="irMenu()">‚¨Ö VOLTAR</button>
    <div id="lista-m" style="width:100%"></div>
</div>
<div id="t-j" class="tela" style="justify-content:flex-start; padding:0">
    <div id="painel">
        <div id="folha">
            <div style="display:flex; justify-content:space-between; background:#eee; padding:5px;"><b style="color:#000">RASCUNHO (Auto-salvamento)</b><button class="btn" style="background:red" onclick="document.getElementById('folha').style.display='none'">X</button></div>
            <textarea id="txt-folha" oninput="localStorage.setItem('piano_txt', this.value)"></textarea>
        </div>
        <div id="container-progresso"><div id="barra-progresso"></div></div>
        <div class="linha">
            <button class="btn" style="background:#f44336" onclick="irMenu()">SAIR</button>
            <b id="txt-m">Livre</b>
            <button class="btn" style="background:#fff; color:#000" onclick="document.getElementById('folha').style.display='flex'">üìù FOLHA</button>
            <button id="btn-rec" class="btn" style="background:#555" onclick="toggleRec()">‚è∫ REC</button>
        </div>
        <div class="linha"><span>PITCH:</span><input type="range" id="pitch" min="0.5" max="2.0" step="0.1" value="1.0"></div>
        <div class="linha"><span>VOL:</span><input type="range" id="vol" min="0" max="1" step="0.1" value="0.6"><button class="btn" style="background:#2196F3" onclick="ecoAtivo=!ecoAtivo; this.innerText=ecoAtivo?'ECO: ON':'ECO: OFF'">ECO: ON</button></div>
    </div>
    <div id="teclado"></div>
</div>
<div id="t-s" class="tela" style="justify-content:flex-start; overflow-y:auto">
    <button class="btn" style="background:#444; margin-bottom:20px; width: 100%" onclick="irMenu()">‚¨Ö VOLTAR</button>
    <div id="lista-salvas" style="width:100%"></div>
                </div>
    <script>
let ctx, mG, notasAtivas = new Map(), mus = null, passo = 0, segurando = false, ecoAtivo = true;
let gravando = false, recorder, chunks = [], listaS = JSON.parse(localStorage.getItem('p_v10') || '[]');
const nms = ['D√≥','D√≥#','R√©','R√©#','Mi','F√°','F√°#','Sol','Sol#','L√°','L√°#','Si','D√≥2','D√≥#2','R√©2','R√©#2','Mi2','F√°2','F√°#2','Sol2','Sol#2','L√°2','L√°#2','Si2','D√≥3'];

// M√öSICAS 100% COMPLETAS COM RITMO, NOTAS LONGAS E RESPIROS
const banco = [
    { id: 1, nome: "Bate o Sino (Inteira)", seq: [[4,400],[4,400],[4,800],[-1,100],[4,400],[4,400],[4,800],[-1,100],[4,400],[7,400],[0,400],[2,400],[4,1200],[-1,200],[5,400],[5,400],[5,400],[5,400],[5,400],[4,400],[4,400],[4,200],[4,200],[4,400],[2,400],[2,400],[4,400],[2,800],[-1,400],[4,400],[4,400],[4,800],[-1,100],[4,400],[4,400],[4,800],[-1,100],[4,400],[7,400],[0,400],[2,400],[4,1200],[-1,200],[5,400],[5,400],[5,400],[5,400],[5,400],[4,400],[4,400],[4,200],[4,200],[7,400],[7,400],[5,400],[2,400],[0,1200]] },
    { id: 2, nome: "Ode √† Alegria (Beethoven Completa)", seq: [[4,400],[4,400],[5,400],[7,400],[7,400],[5,400],[4,400],[2,400],[0,400],[0,400],[2,400],[4,400],[4,600],[2,200],[2,800],[-1,200],[4,400],[4,400],[5,400],[7,400],[7,400],[5,400],[4,400],[2,400],[0,400],[0,400],[2,400],[4,400],[2,600],[0,200],[0,800],[-1,300],[2,400],[2,400],[4,400],[0,400],[2,400],[4,200],[5,200],[4,400],[0,400],[2,400],[4,200],[5,200],[4,400],[2,400],[0,400],[2,400],[7,800],[-1,300],[4,400],[4,400],[5,400],[7,400],[7,400],[5,400],[4,400],[2,400],[0,400],[0,400],[2,400],[4,400],[2,600],[0,200],[0,800]] },
    { id: 3, nome: "Brilha Brilha (Inteira)", seq: [[0,400],[0,400],[7,400],[7,400],[9,400],[9,400],[7,800],[-1,200],[5,400],[5,400],[4,400],[4,400],[2,400],[2,400],[0,800],[-1,200],[7,400],[7,400],[5,400],[5,400],[4,400],[4,400],[2,800],[-1,200],[7,400],[7,400],[5,400],[5,400],[4,400],[4,400],[2,800],[-1,200],[0,400],[0,400],[7,400],[7,400],[9,400],[9,400],[7,800],[-1,200],[5,400],[5,400],[4,400],[4,400],[2,400],[2,400],[0,800]] },
    { id: 4, nome: "Parab√©ns Pra Voc√™", seq: [[0,300],[0,150],[2,450],[0,450],[5,450],[4,900],[-1,300],[0,300],[0,150],[2,450],[0,450],[7,450],[5,900],[-1,300],[0,300],[0,150],[12,450],[9,450],[5,450],[4,450],[2,900],[-1,300],[10,300],[10,150],[9,450],[5,450],[7,450],[5,900]] }
];

async function ligarTudo() {
    if (!ctx) {
        ctx = new (window.AudioContext || window.webkitAudioContext)();
        mG = ctx.createGain(); mG.gain.value = 0.6; mG.connect(ctx.destination);
        let dest = ctx.createMediaStreamDestination(); mG.connect(dest);
        recorder = new MediaRecorder(dest.stream); recorder.ondataavailable = e => chunks.push(e.data);
        recorder.onstop = () => {
            let n = prompt("Salvar grava√ß√£o como:");
            if(n) { listaS.push({ nome: n, url: URL.createObjectURL(new Blob(chunks, {type:'audio/mp3'})), data: new Date().toLocaleString() }); localStorage.setItem('p_v10', JSON.stringify(listaS)); }
            chunks = [];
        };
        document.getElementById('txt-folha').value = localStorage.getItem('piano_txt') || '';
    }
}
function irMenu() { document.querySelectorAll('.tela').forEach(t => t.classList.remove('ativa')); document.getElementById('m-p').classList.add('ativa'); mus=null; }
function irJogo() { document.querySelectorAll('.tela').forEach(t => t.classList.remove('ativa')); document.getElementById('t-j').classList.add('ativa'); }
function irMus() {
    document.querySelectorAll('.tela').forEach(t => t.classList.remove('ativa')); document.getElementById('t-m').classList.add('ativa');
    const l = document.getElementById('lista-m'); l.innerHTML = '';
    banco.forEach(m => { l.innerHTML += `<div style="background:#222; margin-bottom:10px; padding:15px; border-radius:10px; display:flex; justify-content:space-between; align-items:center; color:white"><span>${m.nome}</span><div><button class="btn" style="background:#555; margin-right:5px" onclick="ouvir(${m.id})">OUVIR</button><button class="btn" style="background:#FFD700; color:#000" onclick="playM(${m.id})">JOGAR</button></div></div>`; });
}
async function ouvir(id) { ligarTudo(); let m = banco.find(x => x.id === id); for(let n of m.seq) { if(n[0] !== -1) { som(130.81 * Math.pow(2, n[0]/12), 'tmp'); setTimeout(()=>off('tmp'), n[1]-50); } await new Promise(r => setTimeout(r, n[1])); } }
function playM(id) { mus = banco.find(m => m.id === id); passo = 0; irJogo(); document.getElementById('txt-m').innerText = mus.nome; document.getElementById('container-progresso').style.display = 'block'; prox(); }
function prox() { document.querySelectorAll('.tecla').forEach(t => { t.classList.remove('alvo-amarelo'); t.querySelector('.progresso-nota').style.height = '0%'; }); if(mus) { document.getElementById('barra-progresso').style.width = (passo/mus.seq.length)*100+'%'; if(passo >= mus.seq.length) { alert("Voc√™ tocou a m√∫sica inteira! Parab√©ns!"); irMenu(); return; } if(mus.seq[passo][0]===-1) { setTimeout(()=>{passo++; prox();}, mus.seq[passo][1]); } else { document.getElementById('k'+mus.seq[passo][0]).classList.add('alvo-amarelo'); } } }
function som(f, id) { if(!ctx || notasAtivas.has(id)) return; let o = ctx.createOscillator(), g = ctx.createGain(); o.type = 'triangle'; o.frequency.value = f * document.getElementById('pitch').value; g.gain.setValueAtTime(0, ctx.currentTime); g.gain.linearRampToValueAtTime(0.4, ctx.currentTime+0.02); o.connect(g); g.connect(mG); o.start(); notasAtivas.set(id, {o, g}); }
function off(id) { let n = notasAtivas.get(id); if(n) { let d = ecoAtivo ? 0.7 : 0.1; n.g.gain.linearRampToValueAtTime(0, ctx.currentTime+d); n.o.stop(ctx.currentTime+d+0.1); notasAtivas.delete(id); } }
function toggleRec() { ligarTudo(); const b = document.getElementById('btn-rec'); if(!gravando) { gravando=true; b.innerText="‚èπ PARAR"; b.style.background="#f44336"; recorder.start(); } else { gravando=false; b.innerText="‚è∫ REC"; b.style.background="#555"; recorder.stop(); } }
function irSalvas() { document.querySelectorAll('.tela').forEach(t => t.classList.remove('ativa')); document.getElementById('t-s').classList.add('ativa'); const c = document.getElementById('lista-salvas'); c.innerHTML = ''; listaS.forEach((m, idx) => { c.innerHTML += `<div style="background:#222; padding:15px; margin-bottom:10px; border-radius:10px; color:white"><b>${m.nome}</b><br><audio controls src="${m.url}" style="width:100%; height:30px; margin:10px 0"></audio><br><button class="btn" style="background:#f44336" onclick="listaS.splice(${idx},1); localStorage.setItem('p_v10', JSON.stringify(listaS)); irSalvas()">DEL</button><a href="${m.url}" download="${m.nome}.mp3" class="btn" style="background:#4CAF50; text-decoration:none; margin-left:5px">BAIXAR</a></div>`; }); }
const tcl = document.getElementById('teclado');
for(let i = 0; i < 25; i++) {
    let d = document.createElement('div'), f = 130.81 * Math.pow(2, i/12), id = 'k'+i; d.className = 'tecla ' + (nms[i%12].includes('#')?'preta':'branca'); d.id = id;
    d.innerHTML = `<div class="progresso-nota"></div><small style="pointer-events:none">${nms[i]}</small>`;
    d.onpointerdown = e => { d.setPointerCapture(e.pointerId); hStart(id, f); }; d.onpointerup = e => hEnd(id); tcl.appendChild(d);
}
function hStart(id, f) { ligarTudo(); som(f, id); let el = document.getElementById(id); el.classList.add(nms[parseInt(id.slice(1))%12].includes('#')?'tecla-ativa-preta':'tecla-ativa-branca'); if(mus && id === 'k'+mus.seq[passo][0]) { segurando = true; let p = el.querySelector('.progresso-nota'); p.style.transition = `height ${mus.seq[passo][1]}ms linear`; p.style.height = '100%'; } }
function hEnd(id) { off(id); let el = document.getElementById(id); if(el) el.classList.remove('tecla-ativa-preta','tecla-ativa-branca'); if(mus && segurando && id === 'k'+mus.seq[passo][0]) { segurando = false; passo++; prox(); } }
</script>
</body>
</html>
