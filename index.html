<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <title>Piano Studio - Green Pro Audio</title>
    <style>
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; margin: 0; padding: 0; }
        body, html { width: 100vw; height: 100vh; overflow: hidden; background: #000; font-family: 'Courier New', monospace; color: #00ff00; }
        .tela { position: absolute; width: 100%; height: 100%; display: none; flex-direction: column; align-items: center; padding: 15px; }
        .ativa { display: flex; }
        
        .btn { padding: 12px; border: 1px solid #00ff00; background: transparent; color: #00ff00; font-weight: bold; cursor: pointer; text-transform: uppercase; font-size: 11px; border-radius: 4px; }
        .btn:active { background: #00ff00; color: #000; }
        .btn-destaque { background: #00ff00; color: #000; }

        #painel { width: 100%; background: #080808; padding: 15px; border-bottom: 2px solid #00ff00; display: flex; flex-direction: column; gap: 15px; }
        .row { display: flex; justify-content: space-between; align-items: center; width: 100%; gap: 10px; }
        
        input[type=range] { flex: 1; accent-color: #00ff00; }

        #teclado { flex-grow: 1; width: 100%; display: flex; overflow-x: auto; background: #000; padding-top: 10px; gap: 2px; touch-action: none; }
        .tecla { flex-shrink: 0; border-radius: 0 0 5px 5px; border: 1px solid #222; }
        .branca { width: 60px; height: 100%; background: #fff; }
        .preta { width: 40px; height: 60%; background: #000; margin-left: -20px; margin-right: -20px; z-index: 2; border: 1px solid #00ff00; }
        
        .tecla-ativa { background: #00ff00 !important; box-shadow: 0 0 25px #00ff00; border: none; }
    </style>
</head>
<body>

<div id="m-p" class="tela ativa">
    <h1 style="text-shadow: 0 0 15px #00ff00; margin-bottom: 40px;">PIANO_SYSTEM_V11</h1>
    <button class="btn btn-destaque" style="width: 250px;" onclick="ligarAudio(); ir('t-j')">INICIAR_SISTEMA</button>
</div>

<div id="t-j" class="tela" style="padding:0; background:#000; justify-content: flex-end; overflow:hidden;">
    <div id="painel">
        <div class="row">
            <button class="btn" style="border-color: #f44336; color: #f44336;" onclick="ir('m-p')">SAIR</button>
            <div style="font-size: 10px;">AUDIO_PRO_ENABLED</div>
            <button id="btn-eco" class="btn" onclick="toggleEco()">ECO: OFF</button>
        </div>

        <div class="row">
            <label>VOL</label>
            <input type="range" id="v-sli" min="0" max="15" value="10">
            <label>PITCH</label>
            <input type="range" id="p-sli" min="0" max="15" step="0.5" value="7.5">
        </div>

        <div class="row">
            <button id="btn-rec" class="btn" style="flex:1; border-color: #ff0000;" onclick="toggleRec()">⏺ GRAVAR_MÚSICA</button>
        </div>
    </div>
    <div id="teclado"></div>
</div>

<script>
let ctx, mG, ecoNode, filtro, ecoAtivo = false, gravando = false, notasAtivas = new Map();

const nomes = ['Dó','Dó#','Ré','Ré#','Mi','Fá','Fá#','Sol','Sol#','Lá','Lá#','Si','Dó2','Dó#2','Ré2','Mi2','Fá2','Sol2'];
const freqsBase = nomes.map((_, i) => 130.81 * Math.pow(2, i/12));

async function ligarAudio() { 
    if(!ctx){ 
        ctx = new (window.AudioContext || window.webkitAudioContext)();
        mG = ctx.createGain(); 
        
        // FILTRO PARA MELHORAR O SOM (Tira o som de "bipe" eletrônico)
        filtro = ctx.createBiquadFilter();
        filtro.type = "lowpass";
        filtro.frequency.value = 1200; // Suaviza as notas

        mG.connect(filtro);
        filtro.connect(ctx.destination);
        setupEco();
    }
    if (ctx.state === 'suspended') await ctx.resume();
}

function setupEco() {
    ecoNode = ctx.createConvolver();
    let rate = ctx.sampleRate, len = rate * 1.2, buffer = ctx.createBuffer(2, len, rate);
    for (let i = 0; i < len; i++) {
        let v = Math.exp(-i / (rate * 0.4)) * (Math.random() * 2 - 1);
        buffer.getChannelData(0)[i] = v; buffer.getChannelData(1)[i] = v;
    }
    ecoNode.buffer = buffer;
}

function toggleEco() {
    ecoAtivo = !ecoAtivo;
    const b = document.getElementById('btn-eco');
    b.innerText = `ECO: ${ecoAtivo?'ON':'OFF'}`;
    b.style.background = ecoAtivo?'#00ff00':'transparent';
    b.style.color = ecoAtivo?'#000':'#00ff00';
}

function on(i) {
    if(!ctx) return;
    if(notasAtivas.has(i)) return;
    
    // Usamos 'triangle' em vez de 'sine' para um som mais rico, mas com filtro
    let o = ctx.createOscillator(), g = ctx.createGain();
    o.type = 'triangle'; 
    
    let p = parseFloat(document.getElementById('p-sli').value) - 7.5;
    o.frequency.value = freqsBase[i] * Math.pow(2, p/12);
    
    let v = (document.getElementById('v-sli').value / 15) * 0.3;
    g.gain.setValueAtTime(0, ctx.currentTime);
    g.gain.linearRampToValueAtTime(v, ctx.currentTime + 0.03);

    o.connect(g);
    if(ecoAtivo) { 
        let ecoGain = ctx.createGain();
        ecoGain.gain.value = 0.3;
        g.connect(ecoGain);
        ecoGain.connect(ecoNode);
        ecoNode.connect(mG);
    }
    g.connect(mG);
    
    o.start();
    notasAtivas.set(i, {o, g});
    document.getElementById('key'+i).classList.add('tecla-ativa');
}

function off(i) {
    let n = notasAtivas.get(i);
    if(n) {
        n.g.gain.linearRampToValueAtTime(0, ctx.currentTime + 0.15);
        n.o.stop(ctx.currentTime + 0.3);
        notasAtivas.delete(i);
        document.getElementById('key'+i).classList.remove('tecla-ativa');
    }
}

const tec = document.getElementById('teclado');
nomes.forEach((n, i) => {
    let d = document.createElement('div');
    d.className = `tecla ${n.includes('#')?'preta':'branca'}`; d.id = 'key'+i;
    d.onpointerdown = e => { d.setPointerCapture(e.pointerId); ligarAudio(); on(i); };
    d.onpointerup = e => off(i);
    tec.appendChild(d);
});

function ir(id) { document.querySelectorAll('.tela').forEach(t => t.classList.remove('ativa')); document.getElementById(id).classList.add('ativa'); }

function toggleRec() {
    gravando = !gravando;
    document.getElementById('btn-rec').style.background = gravando ? "red" : "transparent";
    document.getElementById('btn-rec').style.color = gravando ? "white" : "#ff0000";
}
</script>
</body>
</html>
