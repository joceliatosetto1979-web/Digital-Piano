<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <title>Virtual Piano+ Pro Ultra</title>
    <style>
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; margin: 0; padding: 0; }
        body, html { width: 100vw; height: 100vh; overflow: hidden; background: #000; font-family: sans-serif; display: flex; flex-direction: column; }
        .tela { position: absolute; width: 100%; height: 100%; display: none; flex-direction: column; align-items: center; justify-content: center; background: #111; z-index: 10; padding: 20px; }
        .ativa { display: flex; }
        #painel { height: 28%; width: 100%; background: #1a1a1a; display: flex; flex-direction: column; justify-content: space-around; padding: 10px; border-bottom: 2px solid #333; }
        #container-progresso { width: 100%; height: 8px; background: #333; border-radius: 4px; overflow: hidden; margin-bottom: 5px; display: none; }
        #barra-progresso { width: 0%; height: 100%; background: #4CAF50; transition: width .3s; }
        .linha { display: flex; justify-content: space-between; align-items: center; width: 100%; gap: 10px; }
        input[type=range] { flex: 1; accent-color: #FFD700; }
        #teclado { height: 72%; width: 100%; display: flex; overflow-x: auto; touch-action: none; background: #000; padding-top: 10px; }
        .tecla { flex-shrink: 0; position: relative; border-radius: 0 0 10px 10px; display: flex; justify-content: center; align-items: flex-end; padding-bottom: 20px; user-select: none; border: 1px solid #999; transition: transform .05s, background .05s; cursor: pointer; overflow: hidden; }
        .branca { width: 70px; height: 100%; background: #fff; color: #333; z-index: 1; }
        .preta { width: 45px; height: 60%; background: #222; color: #fff; margin-left: -22.5px; margin-right: -22.5px; z-index: 2; border: 1px solid #000; }
        
        /* AS CORES QUE TINHAM SUMIDO VOLTARAM AQUI */
        .tecla-ativa-branca { background: #ccc !important; transform: translateY(4px); }
        .tecla-ativa-preta { background: #000 !important; transform: translateY(4px); }
        
        .progresso-nota { position: absolute; bottom: 0; left: 0; width: 100%; background: #FFD700; height: 0%; z-index: 0; opacity: .8; pointer-events: none; }
        .alvo-amarelo { border: 3px solid #FFD700 !important; box-shadow: 0 0 15px #FFD700; }
        .btn { padding: 12px 20px; border-radius: 8px; border: none; font-weight: 700; cursor: pointer; color: #fff; }
        .btn-menu { width: 220px; padding: 18px; margin: 8px; border-radius: 50px; font-size: 1.1rem; background: #4CAF50; }
        .creditos { position: absolute; bottom: 15px; right: 15px; color: #FFD700; font-size: .8rem; font-weight: 700; }
        @media print { #m-p, #t-j, #t-m, #t-n, .btn, #painel { display: none !important; } .tela { display: block !important; position: static !important; background: #fff !important; } }
    </style>
</head>
<body>

<div id="m-p" class="tela ativa">
    <h1 style="color:#FFD700; margin-bottom:30px">VIRTUAL PIANO+</h1>
    <button class="btn-menu" onclick="irJogo()">PLAY (LIVRE)</button>
    <button class="btn-menu" style="background:#2196F3" onclick="irMus()">M√öSICAS</button>
    <button class="btn-menu" style="background:#FFD700; color:#000" onclick="irNotas()">VER NOTAS</button>
    <div class="creditos">Criador: Jo√£o Gabriel Morais</div>
</div>

<div id="t-n" class="tela" style="justify-content:flex-start; overflow-y:auto">
    <button class="btn" style="background:#555; width: 100%; margin-bottom: 20px" onclick="irMenu()">‚¨Ö VOLTAR</button>
    <div id="lista-notas-texto" style="width:100%"></div>
</div>

<div id="t-m" class="tela" style="justify-content:flex-start; overflow-y:auto">
    <button class="btn" style="background:#555; margin-bottom:20px; width: 100%" onclick="irMenu()">‚¨Ö VOLTAR</button>
    <div id="lista-m" style="width:100%"></div>
</div>

<div id="t-j" class="tela" style="justify-content:flex-start; padding:0">
    <div id="painel">
        <div id="container-progresso"><div id="barra-progresso"></div></div>
        <div class="linha">
            <button class="btn" style="background:#f44336" onclick="irMenu()">SAIR</button>
            <b id="txt-m" style="color:#fff">Modo Livre</b>
            <button id="btn-rec" class="btn" style="background:#555" onclick="toggleRec()">‚è∫ GRAVAR</button>
        </div>
        <div class="linha">
            <span>PITCH:</span>
            <input type="range" id="pitch" min="0.1" max="4.0" step="0.1" value="1.3">
            <b id="val-pitch" style="color:#FFD700">1.3</b>
        </div>
        <div class="linha">
            <span>VOL:</span>
            <input type="range" id="vol" min="0" max="1" step="0.1" value="0.5" oninput="if(mG) mG.gain.value=this.value">
            <b id="val-vol" style="color:#FFD700">50%</b>
        </div>
    </div>
    <div id="teclado"></div>
</div>

<script>
let ctx, mG, rec, chunks = [], notas = new Map(), mus = null, passo = 0, segurando = false;
const nms = ['D√≥','D√≥#','R√©','R√©#','Mi','F√°','F√°#','Sol','Sol#','L√°','L√°#','Si','D√≥2','D√≥#2','R√©2','R√©#2','Mi2','F√°2','F√°#2','Sol2','Sol#2','L√°2','L√°#2','Si2','D√≥3'];

const banco = [
    { id: 1, nome: "Parab√©ns pra Voc√™", pitchBase: 1.2, seq: [[0,300],[0,150],[2,450],[0,450],[5,450],[4,900],[-1,300],[0,300],[0,150],[2,450],[0,450],[7,450],[5,900],[-1,300],[0,300],[0,150],[12,450],[9,450],[5,450],[4,450],[2,900],[-1,300],[10,300],[10,150],[9,450],[5,450],[7,450],[5,900]] },
    { id: 2, nome: "Bate o Sino", pitchBase: 1.3, seq: [[4,300],[4,300],[4,600],[-1,100],[4,300],[4,300],[4,600],[-1,100],[4,300],[7,300],[0,300],[2,300],[4,800],[-1,200],[5,300],[5,300],[5,300],[5,300],[5,300],[4,300],[4,300],[4,300],[2,300],[2,300],[4,300],[2,600],[7,600]] },
    { id: 3, nome: "Baby Shark", pitchBase: 1.6, seq: [[2,400],[-1,50],[4,400],[-1,50],[7,150],[-1,50],[7,150],[-1,50],[7,150],[-1,100],[7,150],[-1,50],[7,150],[-1,50],[7,150],[-1,100],[7,150],[-1,50],[7,150],[-1,50],[7,150],[-1,100],[7,150],[-1,50],[7,150],[-1,50],[6,600]] },
    { id: 4, nome: "Harry Potter Theme", pitchBase: 1.1, seq: [
        [11,400],[-1,100],[16,600],[-1,50],[19,250],[18,250],[-1,50],[16,600],[-1,100],[23,450],[-1,100],[21,800],[-1,300],
        [16,600],[-1,50],[19,250],[18,250],[-1,50],[15,600],[-1,100],[17,450],[-1,100],[11,1000]
    ]}
];

function init() {
    if(!ctx) {
        ctx = new (window.AudioContext || window.webkitAudioContext)();
        mG = ctx.createGain(); mG.gain.value = 0.5; mG.connect(ctx.destination);
        let d = ctx.createMediaStreamDestination(); mG.connect(d);
        rec = new MediaRecorder(d.stream);
        rec.ondataavailable = e => chunks.push(e.data);
        rec.onstop = () => {
            let b = new Blob(chunks, {type: 'audio/webm'}), a = document.createElement('a');
            a.href = URL.createObjectURL(b); a.download = 'piano.webm'; a.click();
        };
    }
}

function irMenu() { document.querySelectorAll('.tela').forEach(t => t.classList.remove('ativa')); document.getElementById('m-p').classList.add('ativa'); }
function irJogo() { document.querySelectorAll('.tela').forEach(t => t.classList.remove('ativa')); document.getElementById('t-j').classList.add('ativa'); document.getElementById('container-progresso').style.display = 'none'; init(); mus = null; document.getElementById('txt-m').innerText = "Modo Livre"; }
function irMus() {
    document.querySelectorAll('.tela').forEach(t => t.classList.remove('ativa')); document.getElementById('t-m').classList.add('ativa');
    const l = document.getElementById('lista-m'); l.innerHTML = '';
    banco.forEach(m => { l.innerHTML += `<div style="background:#222; margin-bottom:10px; padding:15px; border-radius:12px; display:flex; justify-content:space-between; align-items:center; color:#fff"><span>${m.nome}</span><button class="btn" style="background:#FFD700; color:#000" onclick="playM(${m.id})">PLAY</button></div>` });
}
function irNotas() {
    document.querySelectorAll('.tela').forEach(t => t.classList.remove('ativa')); document.getElementById('t-n').classList.add('ativa');
    const c = document.getElementById('lista-notas-texto'); c.innerHTML = '';
    banco.forEach((m, i) => {
        let s = m.seq.filter(n => n[0] !== -1).map(n => nms[n[0]]).join(" - ");
        c.innerHTML += `<div class="card-nota" id="c-${i}"><h3>${m.nome}</h3><p style="color:#ccc">${s}</p><div class="linha" style="margin-top:10px"><button class="btn" style="background:#2196F3; flex:1" onclick="imprimir('c-${i}','azul')">üéº PARTITURA</button><button class="btn" style="background:#f44336; flex:1" onclick="imprimir('c-${i}','vermelho')">üéπ D√ì-R√â-M√ç</button></div></div>`;
    });
}
function imprimir(id, t) { document.querySelectorAll('.card-nota').forEach(c => c.classList.remove('imprimir-agora')); document.getElementById(id).classList.add('imprimir-agora'); window.print(); }
function playM(id) {
    mus = banco.find(m => m.id === id); passo = 0;
    document.getElementById('container-progresso').style.display = 'block';
    document.querySelectorAll('.tela').forEach(t => t.classList.remove('ativa'));
    document.getElementById('t-j').classList.add('ativa'); document.getElementById('txt-m').innerText = mus.nome; init(); prox();
}
function prox() {
    document.querySelectorAll('.tecla').forEach(t => { t.classList.remove('alvo-amarelo'); let p = t.querySelector('.progresso-nota'); p.style.height = '0%'; p.style.transition = 'none'; });
    if(mus) {
        document.getElementById('barra-progresso').style.width = (passo / mus.seq.length) * 100 + '%';
        if(passo >= mus.seq.length) { alert("M√∫sica Conclu√≠da!"); irJogo(); return; }
        let n = mus.seq[passo][0];
        if(n === -1) { setTimeout(() => { passo++; prox(); }, mus.seq[passo][1]); }
        else { document.getElementById('k'+n).classList.add('alvo-amarelo'); }
    }
}

function hStart(id, f) {
    init(); som(f * document.getElementById('pitch').value, id);
    // ADICIONADO: A tecla agora muda de cor visualmente
    const t = document.getElementById(id);
    const isPreta = nms[parseInt(id.slice(1)) % 12].includes('#');
    t.classList.add(isPreta ? 'tecla-ativa-preta' : 'tecla-ativa-branca');

    if(mus && id === 'k' + mus.seq[passo][0]) {
        segurando = true;
        let p = t.querySelector('.progresso-nota');
        p.style.transition = 'none'; p.style.height = '0%';
        setTimeout(() => { if(segurando) { p.style.transition = `height ${mus.seq[passo][1]}ms linear`; p.style.height = '100%'; } }, 50); 
    }
}

function hEnd(id) {
    off(id);
    // REMOVE A COR DE TOQUE
    const t = document.getElementById(id);
    t.classList.remove('tecla-ativa-preta', 'tecla-ativa-branca');
    
    if(mus && segurando && id === 'k' + mus.seq[passo][0]) { segurando = false; passo++; prox(); }
}

const tcl = document.getElementById('teclado');
for(let i = 0; i < 25; i++) {
    let d = document.createElement('div'), f = 130.81 * Math.pow(2, i/12), id = 'k' + i;
    d.className = 'tecla ' + (nms[i%12].includes('#') ? 'preta' : 'branca');
    d.id = id;
    d.innerHTML = `<div class="progresso-nota"></div><small style="pointer-events:none; z-index:5">${nms[i]}</small>`;
    d.onpointerdown = e => { d.setPointerCapture(e.pointerId); hStart(id, f); };
    d.onpointerup = e => hEnd(id);
    tcl.appendChild(d);
}
function som(f, id) {
    if(!ctx || notas.has(id)) return;
    let o = ctx.createOscillator(), g = ctx.createGain();
    o.type = 'triangle'; o.frequency.value = f;
    g.gain.setValueAtTime(0, ctx.currentTime);
    g.gain.linearRampToValueAtTime(0.4, ctx.currentTime + 0.02);
    o.connect(g); g.connect(mG); o.start();
    notas.set(id, {o, g});
}
function off(id) {
    let n = notas.get(id);
    if(n) { 
        n.g.gain.linearRampToValueAtTime(0, ctx.currentTime + 0.4); 
        n.o.stop(ctx.currentTime + 0.45); 
        notas.delete(id); 
    }
}
function toggleRec() {
    init(); const b = document.getElementById('btn-rec');
    if(rec.state === 'inactive') { chunks = []; rec.start(); b.innerText = "‚èπ PARAR"; }
    else { rec.stop(); b.innerText = "‚è∫ GRAVAR"; }
}
document.getElementById('pitch').oninput = e => { document.getElementById('val-pitch').innerText = parseFloat(e.target.value).toFixed(1); };
</script>
</body>
    </html>
    
