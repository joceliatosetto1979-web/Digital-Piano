<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <title>Virtual Piano+ Escuta Ativa</title>
    <style>
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; margin: 0; padding: 0; }
        body, html { width: 100vw; height: 100vh; overflow: hidden; background: #000; font-family: sans-serif; display: flex; flex-direction: column; }
        
        .tela { position: absolute; width: 100%; height: 100%; display: none; flex-direction: column; align-items: center; justify-content: center; background: #111; z-index: 10; padding: 20px; }
        .ativa { display: flex; }
        
        #painel { height: 32%; width: 100%; background: #1a1a1a; display: flex; flex-direction: column; justify-content: space-around; padding: 10px; border-bottom: 2px solid #333; }
        #container-progresso { width: 100%; height: 8px; background: #333; border-radius: 4px; overflow: hidden; margin-bottom: 5px; display: none; }
        #barra-progresso { width: 0%; height: 100%; background: #4CAF50; transition: width .3s; }
        
        .linha { display: flex; justify-content: space-between; align-items: center; width: 100%; gap: 10px; color: white; }
        input[type=range] { flex: 1; accent-color: #FFD700; }
        
        #teclado { height: 68%; width: 100%; display: flex; overflow-x: auto; touch-action: none; background: #000; padding-top: 10px; }
        .tecla { flex-shrink: 0; position: relative; border-radius: 0 0 10px 10px; display: flex; justify-content: center; align-items: flex-end; padding-bottom: 20px; user-select: none; border: 1px solid #999; transition: transform .05s, background .05s; cursor: pointer; overflow: hidden; }
        .branca { width: 70px; height: 100%; background: #fff; color: #333; z-index: 1; }
        .preta { width: 45px; height: 60%; background: #222; color: #fff; margin-left: -22.5px; margin-right: -22.5px; z-index: 2; border: 1px solid #000; }
        
        .tecla-ativa-branca { background: #bbb !important; transform: translateY(5px); }
        .tecla-ativa-preta { background: #000 !important; transform: translateY(5px); }
        .progresso-nota { position: absolute; bottom: 0; left: 0; width: 100%; background: #FFD700; height: 0%; z-index: 0; opacity: .8; pointer-events: none; }
        .alvo-amarelo { border: 4px solid #FFD700 !important; box-shadow: 0 0 20px #FFD700; }
        
        .btn { padding: 10px 15px; border-radius: 8px; border: none; font-weight: 700; cursor: pointer; color: #fff; display: flex; align-items: center; justify-content: center; }
        .btn-menu { width: 250px; padding: 18px; margin: 10px; border-radius: 50px; font-size: 1.1rem; background: #4CAF50; color: white; border: none; font-weight: bold; }
        
        .btn-preview { background: #ff0000; width: 40px; height: 30px; border-radius: 8px; display: flex; align-items: center; justify-content: center; margin-right: 10px; }
        .btn-preview::after { content: ''; border-style: solid; border-width: 6px 0 6px 10px; border-color: transparent transparent transparent white; }

        #modal-folha { display: none; position: absolute; top: 10%; left: 5%; width: 90%; height: 75%; background: #fff; z-index: 100; padding: 15px; border-radius: 10px; flex-direction: column; }
        #texto-folha { flex: 1; width: 100%; border: 1px solid #ccc; padding: 10px; font-size: 1.2rem; resize: none; border-radius: 5px; outline: none; }
        
        .card-salva { background: #222; padding: 15px; margin-bottom: 15px; border-radius: 10px; border-left: 6px solid #FFD700; width: 100%; }
        #status-conexao { font-size: 0.8rem; margin-top: 10px; text-align: center; }
        .status-on { color: #4CAF50; }
        .status-off { color: #f44336; }
    </style>
</head>
<body>

<div id="m-p" class="tela ativa">
    <h1 style="color:#FFD700; margin-bottom:10px; font-size: 2.2rem;">PIANO SENSORIAL</h1>
    <div id="status-conexao">
        <span id="midi-info" class="status-off">üéπ MIDI: Off</span> | 
        <span id="mic-info" class="status-off">üé§ Escuta: Off</span>
    </div>
    <button class="btn-menu" style="margin-top:20px" onclick="ativarSensores()">LIGAR ESCUTA/MIDI</button>
    <button class="btn-menu" style="background:#2196F3" onclick="irMus()">M√öSICAS</button>
    <button class="btn-menu" style="background:#FF9800" onclick="irSalvas()">M√öSICAS SALVAS</button>
</div>

<div id="t-m" class="tela" style="justify-content:flex-start; overflow-y:auto">
    <button class="btn" style="background:#444; margin-bottom:20px; width: 100%" onclick="irMenu()">‚¨Ö VOLTAR</button>
    <div id="lista-m" style="width:100%"></div>
</div>

<div id="t-s" class="tela" style="justify-content:flex-start; overflow-y:auto">
    <button class="btn" style="background:#444; margin-bottom:20px; width: 100%" onclick="irMenu()">‚¨Ö VOLTAR</button>
    <h2 style="color:white; margin-bottom:20px">Minhas Grava√ß√µes</h2>
    <div id="lista-salvas" style="width:100%"></div>
</div>

<div id="t-j" class="tela" style="justify-content:flex-start; padding:0">
    <div id="painel">
        <div id="container-progresso"><div id="barra-progresso"></div></div>
        <div class="linha">
            <button class="btn" style="background:#f44336" onclick="irMenu()">SAIR</button>
            <b id="txt-m">Livre</b>
            <button id="btn-folha" class="btn" style="background:#fff; color:#000; font-weight:bold; display:none" onclick="abrirFolha()">üìù FOLHA</button>
            <button id="btn-rec" class="btn" style="background:#555" onclick="toggleRec()">‚è∫ GRAVAR</button>
        </div>
        <div class="linha">
            <span>PITCH:</span>
            <input type="range" id="pitch" min="0.5" max="2.0" step="0.1" value="1.0">
            <button id="btn-eco" class="btn" style="background:#2196F3; font-size: 0.8rem;" onclick="toggleEco()">ECO: ON</button>
        </div>
        <div class="linha">
            <span>VOL:</span>
            <input type="range" id="vol" min="0" max="1" step="0.1" value="0.6">
        </div>
    </div>
    <div id="teclado"></div>

    <div id="modal-folha">
        <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
            <b>Folha de Rascunho</b>
            <button class="btn" style="background:red" onclick="fecharFolha()">X</button>
        </div>
        <textarea id="texto-folha"></textarea>
    </div>
</div>

<script>
// [AGUARDANDO RESTO]
    let ctx, mG, notasAtivas = new Map(), mus = null, passo = 0, segurando = false;
let ecoAtivo = true, gravandoLocal = false, notasGravadas = [], recorder;
let midiAtivo = false, micAtivo = false, streamMic = null, processorMic = null;
let listaGravacoes = JSON.parse(localStorage.getItem('piano_pro_tracks_v3') || '[]');
const nms = ['D√≥','D√≥#','R√©','R√©#','Mi','F√°','F√°#','Sol','Sol#','L√°','L√°#','Si','D√≥2','D√≥#2','R√©2','R√©#2','Mi2','F√°2','F√°#2','Sol2','Sol#2','L√°2','L√°#2','Si2','D√≥3'];

const banco = [
    { id: 1, nome: "Bate o Sino (Jingle Bells)", seq: [[4,400],[4,400],[4,800],[-1,100],[4,400],[4,400],[4,800],[-1,100],[4,400],[7,400],[0,400],[2,400],[4,1200],[-1,200],[5,400],[5,400],[5,400],[5,400],[5,400],[4,400],[4,400],[4,200],[4,200],[7,400],[7,400],[5,400],[2,400],[0,1200]] },
    { id: 2, nome: "Ode √† Alegria (Beethoven)", seq: [[4,400],[4,400],[5,400],[7,400],[7,400],[5,400],[4,400],[2,400],[0,400],[0,400],[2,400],[4,400],[4,600],[2,200],[2,800]] },
    { id: 3, nome: "Memory (Undertale)", seq: [[11,800],[13,800],[14,1200],[-1,100],[11,800],[13,800],[14,1200],[-1,100],[11,800],[13,800],[14,800],[18,800],[16,2000]] }
];

// --- CONTROLES DE SENSORES (USB E √ÅUDIO) ---
function ativarSensores() {
    init();
    toggleMIDI();
    toggleMic();
}

function toggleMIDI() {
    if (!navigator.requestMIDIAccess) return alert("Navegador sem suporte MIDI.");
    const info = document.getElementById('midi-info');
    if (!midiAtivo) {
        navigator.requestMIDIAccess().then(m => {
            midiAtivo = true;
            info.innerText = "üéπ USB: Conectado"; info.className = "status-on";
            m.onstatechange = (e) => { if(e.port.state === 'disconnected') { midiAtivo = false; info.innerText = "üéπ USB: Desconectado"; info.className = "status-off"; }};
            for (let input of m.inputs.values()) {
                input.onmidimessage = (msg) => {
                    if(!midiAtivo) return;
                    let [cmd, note, vel] = msg.data;
                    let id = note - 48;
                    if (cmd === 144 && vel > 0) hStart('k'+id, 130.81 * Math.pow(2, id/12));
                    else if (cmd === 128 || (cmd === 144 && vel === 0)) hEnd('k'+id);
                };
            }
        });
    } else {
        midiAtivo = false;
        info.innerText = "üéπ USB: Desconectado"; info.className = "status-off";
    }
}

function toggleMic() {
    const info = document.getElementById('mic-info');
    if (!micAtivo) {
        navigator.mediaDevices.getUserMedia({ audio: true }).then(s => {
            micAtivo = true; streamMic = s;
            info.innerText = "üé§ Escuta: Ligada"; info.className = "status-on";
            detectarPitch(s);
        }).catch(() => alert("Erro ao acessar microfone."));
    } else {
        micAtivo = false;
        if (streamMic) streamMic.getTracks().forEach(t => t.stop());
        info.innerText = "üé§ Escuta: Desligada"; info.className = "status-off";
    }
}

function detectarPitch(stream) {
    const src = ctx.createMediaStreamSource(stream);
    const analyzer = ctx.createAnalyser();
    analyzer.fftSize = 2048;
    src.connect(analyzer);
    const buffer = new Float32Array(analyzer.fftSize);

    function loop() {
        if (!micAtivo) return;
        analyzer.getFloatTimeDomainData(buffer);
        let freq = autoCorrelate(buffer, ctx.sampleRate);
        if (freq !== -1) {
            let n = Math.round(12 * (Math.log2(freq / 130.81)));
            if (n >= 0 && n < 25) {
                hStart('k'+n, 130.81 * Math.pow(2, n/12));
                setTimeout(() => hEnd('k'+n), 200);
            }
        }
        requestAnimationFrame(loop);
    }
    loop();
}

function autoCorrelate(buf, sampleRate) {
    let SIZE = buf.length, rms = 0;
    for (let i=0; i<SIZE; i++) rms += buf[i]*buf[i];
    if (Math.sqrt(rms/SIZE) < 0.02) return -1;
    let r1=0, r2=SIZE-1, thres=0.2;
    for (let i=0; i<SIZE/2; i++) if (Math.abs(buf[i]) < thres) { r1=i; break; }
    for (let i=1; i<SIZE/2; i++) if (Math.abs(buf[SIZE-i]) < thres) { r2=SIZE-i; break; }
    buf = buf.slice(r1,r2); SIZE = buf.length;
    let c = new Float32Array(SIZE);
    for (let i=0; i<SIZE; i++) for (let j=0; j<SIZE-i; j++) c[i] += buf[j]*buf[j+i];
    let d=0; while (c[d]>c[d+1]) d++;
    let maxval=-1, maxpos=-1;
    for (let i=d; i<SIZE; i++) if (c[i] > maxval) { maxval=c[i]; maxpos=i; }
    return sampleRate/maxpos;
}

// --- FUN√á√ïES DE √ÅUDIO E INTERFACE (IGUAIS AO ANTERIOR) ---
function init() {
    if(!ctx) {
        ctx = new (window.AudioContext || window.webkitAudioContext)();
        mG = ctx.createGain(); mG.gain.value = 0.6;
        let dest = ctx.createMediaStreamDestination();
        mG.connect(dest); mG.connect(ctx.destination);
        recorder = new MediaRecorder(dest.stream);
        let chunks = [];
        recorder.ondataavailable = e => chunks.push(e.data);
        recorder.onstop = () => {
            let blob = new Blob(chunks, { type: 'audio/mp3' });
            let a = document.createElement('a'); a.href = URL.createObjectURL(blob);
            a.download = `grava√ß√£o_${Date.now()}.mp3`; a.click();
        };
    }
}

function som(f, id) {
    if(!ctx || notasAtivas.has(id)) return;
    let o = ctx.createOscillator(), g = ctx.createGain();
    o.type = 'triangle'; o.frequency.value = f;
    g.gain.setValueAtTime(0, ctx.currentTime);
    g.gain.linearRampToValueAtTime(0.4, ctx.currentTime + 0.02);
    o.connect(g); g.connect(mG); o.start();
    notasAtivas.set(id, {o, g});
    if(gravandoLocal) notasGravadas.push({ n: nms[parseInt(id.slice(1))], t: Date.now() });
}

function off(id) {
    let n = notasAtivas.get(id);
    if(n) {
        let dec = ecoAtivo ? 0.8 : 0.05;
        n.g.gain.linearRampToValueAtTime(0, ctx.currentTime + dec);
        n.o.stop(ctx.currentTime + dec + 0.1);
        notasAtivas.delete(id);
    }
}

// --- UI E MENUS ---
function irMenu() { document.querySelectorAll('.tela').forEach(t => t.classList.remove('ativa')); document.getElementById('m-p').classList.add('ativa'); }
function irJogo() { 
    document.querySelectorAll('.tela').forEach(t => t.classList.remove('ativa')); 
    document.getElementById('t-j').classList.add('ativa'); 
    document.getElementById('btn-folha').style.display = 'block';
    document.getElementById('container-progresso').style.display = 'none';
    mus = null; init(); 
}

function irMus() {
    document.querySelectorAll('.tela').forEach(t => t.classList.remove('ativa')); 
    document.getElementById('t-m').classList.add('ativa');
    const l = document.getElementById('lista-m'); l.innerHTML = '';
    banco.forEach(m => { 
        l.innerHTML += `<div style="background:#222; margin-bottom:12px; padding:15px; border-radius:12px; display:flex; justify-content:space-between; align-items:center; color:#fff">
            <div style="display:flex; align-items:center;"><div class="btn-preview" onclick="ouvir(${m.id})"></div><span>${m.nome}</span></div>
            <button class="btn" style="background:#FFD700; color:#000" onclick="playM(${m.id})">JOGAR</button>
        </div>`;
    });
}

async function ouvir(id) {
    init(); let m = banco.find(x => x.id === id);
    for(let n of m.seq) {
        if(n[0] !== -1) { som(130.81 * Math.pow(2, n[0]/12), 'temp'); setTimeout(()=>off('temp'), n[1]-50); }
        await new Promise(r => setTimeout(r, n[1]));
    }
}

function playM(id) {
    mus = banco.find(m => m.id === id); passo = 0;
    document.getElementById('container-progresso').style.display = 'block';
    document.querySelectorAll('.tela').forEach(t => t.classList.remove('ativa'));
    document.getElementById('t-j').classList.add('ativa'); 
    document.getElementById('btn-folha').style.display = 'none';
    document.getElementById('txt-m').innerText = mus.nome;
    init(); prox();
}

function prox() {
    document.querySelectorAll('.tecla').forEach(t => { t.classList.remove('alvo-amarelo'); t.querySelector('.progresso-nota').style.height = '0%'; });
    if(mus) {
        document.getElementById('barra-progresso').style.width = (passo / mus.seq.length) * 100 + '%';
        if(passo >= mus.seq.length) { alert("M√∫sica Finalizada!"); irJogo(); return; }
        if(mus.seq[passo][0] === -1) { setTimeout(() => { passo++; prox(); }, mus.seq[passo][1]); }
        else { document.getElementById('k'+mus.seq[passo][0]).classList.add('alvo-amarelo'); }
    }
}

function toggleRec() {
    init(); const b = document.getElementById('btn-rec');
    if(!gravandoLocal) {
        gravandoLocal = true; b.innerText = "‚èπ PARAR"; b.style.background = "#f44336"; recorder.start();
    } else {
        gravandoLocal = false; b.innerText = "‚è∫ GRAVAR"; b.style.background = "#555"; recorder.stop();
        let nome = prompt("Salvar como:", "Minha Grava√ß√£o");
        if(nome) {
            listaGravacoes.push({ id: Date.now(), nome, notas: [...notasGravadas] });
            localStorage.setItem('piano_pro_tracks_v3', JSON.stringify(listaGravacoes));
        }
    }
}

function irSalvas() {
    document.querySelectorAll('.tela').forEach(t => t.classList.remove('ativa'));
    document.getElementById('t-s').classList.add('ativa');
    const container = document.getElementById('lista-salvas'); container.innerHTML = '';
    listaGravacoes.forEach(m => {
        container.innerHTML += `<div class="card-salva"><div class="card-header"><b>${m.nome}</b></div>
            <div class="card-acoes"><button class="btn" style="background:#2196F3" onclick="verN(${m.id})">üëÅÔ∏è NOTAS</button>
            <button class="btn" style="background:#f44336" onclick="delN(${m.id})">üóëÔ∏è APAGAR</button></div></div>`;
    });
}

function verN(id) {
    let m = listaGravacoes.find(x => x.id === id);
    document.getElementById('texto-notas').innerText = m.notas.map(x => x.n).join(" - ");
    document.getElementById('modal-notas').style.display = 'flex';
}

function delN(id) { if(confirm("Excluir?")) { listaGravacoes = listaGravacoes.filter(x => x.id !== id); localStorage.setItem('piano_pro_tracks_v3', JSON.stringify(listaGravacoes)); irSalvas(); } }
function toggleEco() { ecoAtivo = !ecoAtivo; document.getElementById('btn-eco').innerText = `ECO: ${ecoAtivo?'ON':'OFF'}`; }
function abrirFolha() { document.getElementById('modal-folha').style.display = 'flex'; }
function fecharFolha() { document.getElementById('modal-folha').style.display = 'none'; }

const tcl = document.getElementById('teclado');
for(let i = 0; i < 25; i++) {
    let d = document.createElement('div'), f = 130.81 * Math.pow(2, i/12), id = 'k' + i;
    d.className = 'tecla ' + (nms[i%12].includes('#') ? 'preta' : 'branca');
    d.id = id; d.innerHTML = `<div class="progresso-nota"></div><small style="pointer-events:none">${nms[i]}</small>`;
    d.onpointerdown = e => { d.setPointerCapture(e.pointerId); hStart(id, f); };
    d.onpointerup = e => hEnd(id);
    tcl.appendChild(d);
}

function hStart(id, f) {
    init(); som(f * document.getElementById('pitch').value, id);
    let el = document.getElementById(id); if(!el) return;
    el.classList.add(nms[parseInt(id.slice(1))%12].includes('#')?'tecla-ativa-preta':'tecla-ativa-branca');
    if(mus && id === 'k' + mus.seq[passo][0]) {
        segurando = true; let p = el.querySelector('.progresso-nota');
        p.style.transition = `height ${mus.seq[passo][1]}ms linear`; p.style.height = '100%';
    }
}

function hEnd(id) {
    off(id); let el = document.getElementById(id); if(!el) return;
    el.classList.remove('tecla-ativa-preta','tecla-ativa-branca');
    if(mus && segurando && id === 'k' + mus.seq[passo][0]) { segurando = false; passo++; prox(); }
}

// Vincular os textos do menu como bot√µes clic√°veis
document.getElementById('midi-info').onclick = toggleMIDI;
document.getElementById('mic-info').onclick = toggleMic;
</script>
</body>
</html>
