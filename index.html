let ctx, mG, notasAtivas = new Map(), mus = null, passo = 0, segurando = false, ecoAtivo = true;
let gravando = false, recorder, chunks = [], listaS = JSON.parse(localStorage.getItem('p_v12') || '[]');
const nms = ['Dó','Dó#','Ré','Ré#','Mi','Fá','Fá#','Sol','Sol#','Lá','Lá#','Si','Dó2','Dó#2','Ré2','Ré#2','Mi2','Fá2','Fá#2','Sol2','Sol#2','Lá2','Lá#2','Si2','Dó3'];

const banco = [
    { id: 1, nome: "Bate o Sino", seq: [[4,400],[4,400],[4,800],[-1,100],[4,400],[4,400],[4,800],[-1,100],[4,400],[7,400],[0,400],[2,400],[4,1200],[-1,200],[5,400],[5,400],[5,400],[5,400],[5,400],[4,400],[4,400],[4,200],[4,200],[4,400],[2,400],[2,400],[4,400],[2,800],[-1,400],[4,400],[4,400],[4,800],[-1,100],[4,400],[4,400],[4,800],[-1,100],[4,400],[7,400],[0,400],[2,400],[4,1200],[-1,200],[5,400],[5,400],[5,400],[5,400],[5,400],[4,400],[4,400],[4,200],[4,200],[7,400],[7,400],[5,400],[2,400],[0,1200]] },
    { id: 2, nome: "Ode à Alegria", seq: [[4,400],[4,400],[5,400],[7,400],[7,400],[5,400],[4,400],[2,400],[0,400],[0,400],[2,400],[4,400],[4,600],[2,200],[2,800],[-1,200],[4,400],[4,400],[5,400],[7,400],[7,400],[5,400],[4,400],[2,400],[0,400],[0,400],[2,400],[4,400],[2,600],[0,200],[0,800],[-1,300],[2,400],[2,400],[4,400],[0,400],[2,400],[4,200],[5,200],[4,400],[0,400],[2,400],[4,200],[5,200],[4,400],[2,400],[0,400],[2,400],[7,800],[-1,300],[4,400],[4,400],[5,400],[7,400],[7,400],[5,400],[4,400],[2,400],[0,400],[0,400],[2,400],[4,400],[2,600],[0,200],[0,800]] },
    { id: 3, nome: "Brilha Brilha", seq: [[0,400],[0,400],[7,400],[7,400],[9,400],[9,400],[7,800],[-1,200],[5,400],[5,400],[4,400],[4,400],[2,400],[2,400],[0,800],[-1,200],[7,400],[7,400],[5,400],[5,400],[4,400],[4,400],[2,800],[-1,200],[7,400],[7,400],[5,400],[5,400],[4,400],[4,400],[2,800],[-1,200],[0,400],[0,400],[7,400],[7,400],[9,400],[9,400],[7,800],[-1,200],[5,400],[5,400],[4,400],[4,400],[2,400],[2,400],[0,800]] },
    { id: 4, nome: "Parabéns", seq: [[0,300],[0,150],[2,450],[0,450],[5,450],[4,900],[-1,300],[0,300],[0,150],[2,450],[0,450],[7,450],[5,900],[-1,300],[0,300],[0,150],[12,450],[9,450],[5,450],[4,450],[2,900],[-1,300],[10,300],[10,150],[9,450],[5,450],[7,450],[5,900]] }
];

async function ligarTudo() {
    if (!ctx) {
        ctx = new (window.AudioContext || window.webkitAudioContext)();
        mG = ctx.createGain(); mG.connect(ctx.destination);
        let dest = ctx.createMediaStreamDestination(); mG.connect(dest);
        recorder = new MediaRecorder(dest.stream); recorder.ondataavailable = e => chunks.push(e.data);
        recorder.onstop = () => {
            let n = prompt("Nome da gravação:");
            if(n) { listaS.push({ nome: n, url: URL.createObjectURL(new Blob(chunks, {type:'audio/mp3'})) }); localStorage.setItem('p_v12', JSON.stringify(listaS)); }
            chunks = [];
        };
        document.getElementById('txt-folha').value = localStorage.getItem('piano_txt') || '';
    }
}

function som(f, id) {
    if(!ctx || notasAtivas.has(id)) return;
    mG.gain.value = document.getElementById('vol').value;
    let o = ctx.createOscillator(), g = ctx.createGain();
    o.type = 'triangle'; o.frequency.value = f * document.getElementById('pitch').value;
    g.gain.setValueAtTime(0, ctx.currentTime); g.gain.linearRampToValueAtTime(0.4, ctx.currentTime+0.02);
    o.connect(g); g.connect(mG); o.start(); notasAtivas.set(id, {o, g});
}

function off(id) {
    let n = notasAtivas.get(id);
    if(n) { let d = ecoAtivo ? 0.7 : 0.1; n.g.gain.linearRampToValueAtTime(0, ctx.currentTime+d); n.o.stop(ctx.currentTime+d+0.1); notasAtivas.delete(id); }
}

const tcl = document.getElementById('teclado');
for(let i = 0; i < 25; i++) {
    let d = document.createElement('div'), f = 130.81 * Math.pow(2, i/12), id = 'k'+i;
    d.className = `tecla ${i < 12 ? 'oitava-1' : 'oitava-2'} ` + (nms[i%12].includes('#')?'preta':'branca');
    d.id = id; d.innerHTML = `<div class="progresso-nota"></div><small style="pointer-events:none; font-size:9px">${nms[i]}</small>`;
    d.onpointerdown = e => { d.setPointerCapture(e.pointerId); hStart(id, f); };
    d.onpointerup = e => hEnd(id); tcl.appendChild(d);
}

function hStart(id, f) {
    ligarTudo(); som(f, id);
    let el = document.getElementById(id);
    if(el) el.classList.add(nms[parseInt(id.slice(1))%12].includes('#')?'tecla-ativa-preta':'tecla-ativa-branca');
    if(mus && id === 'k'+mus.seq[passo][0]) {
        segurando = true; let p = el.querySelector('.progresso-nota');
        if(p) { p.style.transition = `height ${mus.seq[passo][1]}ms linear`; p.style.height = '100%'; }
    }
}

function hEnd(id) {
    off(id); let el = document.getElementById(id);
    if(el) el.classList.remove('tecla-ativa-preta','tecla-ativa-branca');
    if(mus && segurando && id === 'k'+mus.seq[passo][0]) { segurando = false; passo++; prox(); }
}

function irMenu() { document.querySelectorAll('.tela').forEach(t => t.classList.remove('ativa')); document.getElementById('m-p').classList.add('ativa'); mus=null; }
function irJogo() { document.querySelectorAll('.tela').forEach(t => t.classList.remove('ativa')); document.getElementById('t-j').classList.add('ativa'); document.getElementById('txt-m').innerText = "MODO LIVRE"; document.getElementById('container-progresso').style.display = 'none'; }
function irMus() { 
    document.querySelectorAll('.tela').forEach(t => t.classList.remove('ativa')); document.getElementById('t-m').classList.add('ativa');
    const l = document.getElementById('lista-m'); l.innerHTML = '';
    banco.forEach(m => { l.innerHTML += `<div style="background:#222; margin-bottom:10px; padding:15px; border-radius:10px; display:flex; justify-content:space-between; align-items:center; color:white"><span>${m.nome}</span><div><button class="btn" style="background:#555; margin-right:5px; padding:5px 10px;" onclick="ouvir(${m.id})">OUVIR</button><button class="btn" style="background:#00ff00; color:#000; padding:5px 10px;" onclick="playM(${m.id})">JOGAR</button></div></div>`; });
}
function playM(id) { mus = banco.find(m => m.id === id); passo = 0; document.querySelectorAll('.tela').forEach(t => t.classList.remove('ativa')); document.getElementById('t-j').classList.add('ativa'); document.getElementById('txt-m').innerText = mus.nome; document.getElementById('container-progresso').style.display = 'block'; prox(); }
function prox() { document.querySelectorAll('.tecla').forEach(t => { t.classList.remove('alvo-amarelo'); t.querySelector('.progresso-nota').style.height = '0%'; }); if(mus) { document.getElementById('barra-progresso').style.width = (passo/mus.seq.length)*100+'%'; if(passo >= mus.seq.length) { alert("Música Concluída!"); irMenu(); return; } if(mus.seq[passo][0]===-1) { setTimeout(()=>{passo++; prox();}, mus.seq[passo][1]); } else { document.getElementById('k'+mus.seq[passo][0]).classList.add('alvo-amarelo'); } } }
async function ouvir(id) { ligarTudo(); let m = banco.find(x => x.id === id); for(let n of m.seq) { if(n[0] !== -1) { som(130.81 * Math.pow(2, n[0]/12), 'tmp'); setTimeout(()=>off('tmp'), n[1]-50); } await new Promise(r => setTimeout(r, n[1])); } }
function toggleRec() { ligarTudo(); const b = document.getElementById('btn-rec'); if(!gravando){ gravando=true; b.innerText="⏹ PARAR"; b.style.background="red"; recorder.start(); } else { gravando=false; b.innerText="⏺ REC"; b.style.background="#555"; recorder.stop(); } }
function irSalvas() { document.querySelectorAll('.tela').forEach(t => t.classList.remove('ativa')); document.getElementById('t-s').classList.add('ativa'); const c = document.getElementById('lista-salvas'); c.innerHTML = ''; listaS.forEach((m, idx) => { c.innerHTML += `<div style="background:#222; padding:15px; margin-bottom:10px; border-radius:10px; color:white"><b>${m.nome}</b><br><audio controls src="${m.url}" style="width:100%; height:30px; margin:10px 0"></audio><br><button class="btn" style="background:red; padding: 5px 10px;" onclick="listaS.splice(${idx},1); localStorage.setItem('p_v12', JSON.stringify(listaS)); irSalvas()">DEL</button></div>`; }); }

/* ================== SISTEMA USB MIDI ================== */
let usbAtivo = false;
let midiAccess = null;

function ativarUSB() {
    const btn = document.getElementById('btn-usb');
    if (usbAtivo) {
        usbAtivo = false; btn.innerText = "USB: OFF"; btn.style.background = "#673AB7";
        if (midiAccess) for (let i of midiAccess.inputs.values()) i.onmidimessage = null;
        return;
    }
    if (navigator.requestMIDIAccess) {
        navigator.requestMIDIAccess().then(a => {
            midiAccess = a; usbAtivo = true; btn.innerText = "USB: ON"; btn.style.background = "#00ff00";
            for (let i of a.inputs.values()) {
                i.onmidimessage = m => {
                    if (!usbAtivo) return;
                    const [c, n, v] = m.data; let x = n - 48; // C3 = 48
                    if (x >= 0 && x < 25) { // Evita erro se tocar nota fora das 25 teclas
                        if (c === 144 && v > 0) hStart('k' + x, 130.81 * Math.pow(2, x / 12));
                        else if (c === 128 || (c === 144 && v === 0)) hEnd('k' + x);
                    }
                }
            }
        }).catch(() => alert("Erro ao acessar MIDI USB."));
    } else alert("Seu navegador não suporta Web MIDI API.");
}

/* ================== SISTEMA MICROFONE (PITCH DETECT) ================== */
let micStream = null, micAnalyser = null, micReqFrame = null, notaAtualMic = -1;

async function ativarMic() {
    const btn = document.getElementById('btn-mic');
    if (micStream) {
        micStream.getTracks().forEach(t => t.stop()); micStream = null; cancelAnimationFrame(micReqFrame);
        if (notaAtualMic !== -1) { hEnd('k' + notaAtualMic); notaAtualMic = -1; }
        btn.innerText = "MIC: OFF"; btn.style.background = "#E91E63"; return;
    }
    try {
        await ligarTudo();
        micStream = await navigator.mediaDevices.getUserMedia({ audio: true });
        btn.innerText = "MIC: ON"; btn.style.background = "#00ff00";
        let source = ctx.createMediaStreamSource(micStream);
        micAnalyser = ctx.createAnalyser(); micAnalyser.fftSize = 2048;
        source.connect(micAnalyser); detectarPitch();
    } catch (e) { alert("Erro ao acessar microfone."); }
}

// Algoritmo de Autocorrelação para encontrar a frequência exata
function autoCorrelate(buf, sampleRate) {
    let SIZE = buf.length; let rms = 0;
    for (let i = 0; i < SIZE; i++) rms += buf[i] * buf[i];
    rms = Math.sqrt(rms / SIZE);
    if (rms < 0.01) return -1; // Volume muito baixo
    let r1 = 0, r2 = SIZE - 1, thres = 0.2;
    for (let i = 0; i < SIZE / 2; i++) if (Math.abs(buf[i]) < thres) { r1 = i; break; }
    for (let i = 1; i < SIZE / 2; i++) if (Math.abs(buf[SIZE - i]) < thres) { r2 = SIZE - i; break; }
    buf = buf.slice(r1, r2); SIZE = buf.length;
    let c = new Array(SIZE).fill(0);
    for (let i = 0; i < SIZE; i++) for (let j = 0; j < SIZE - i; j++) c[i] = c[i] + buf[j] * buf[j + i];
    let d = 0; while (c[d] > c[d + 1]) d++;
    let maxval = -1, maxpos = -1;
    for (let i = d; i < SIZE; i++) if (c[i] > maxval) { maxval = c[i]; maxpos = i; }
    let T0 = maxpos, x1 = c[T0 - 1], x2 = c[T0], x3 = c[T0 + 1];
    let a = (x1 + x3 - 2 * x2) / 2, b = (x3 - x1) / 2;
    if (a) T0 = T0 - b / (2 * a);
    return sampleRate / T0;
}

function detectarPitch() {
    if (!micStream) return;
    let buffer = new Float32Array(micAnalyser.fftSize);
    micAnalyser.getFloatTimeDomainData(buffer);
    let freq = autoCorrelate(buffer, ctx.sampleRate);

    if (freq !== -1) {
        // Converte a frequência detectada para o número da nota MIDI
        let midi = Math.round(12 * (Math.log2(freq / 440)) + 69);
        let idx = midi - 48; // Mapeia para as nossas 25 teclas (C3 = 48)

        if (idx >= 0 && idx < 25) {
            if (notaAtualMic !== idx) {
                if (notaAtualMic !== -1) hEnd('k' + notaAtualMic);
                notaAtualMic = idx;
                hStart('k' + idx, 130.81 * Math.pow(2, idx / 12));
            }
        } else {
            if (notaAtualMic !== -1) { hEnd('k' + notaAtualMic); notaAtualMic = -1; }
        }
    } else {
        if (notaAtualMic !== -1) { hEnd('k' + notaAtualMic); notaAtualMic = -1; }
    }
    micReqFrame = requestAnimationFrame(detectarPitch);
}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
